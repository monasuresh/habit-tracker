<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habits</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 50px;
        }

        h1 {
            color: #007bff;
        }

        .list-group-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            margin-bottom: 5px;
        }

        .list-group-item:hover {
            background-color: #e2e6ea;
        }

        .modal-content {
            border-radius: 10px;
        }

        label {
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 class="text-center mb-4">Habits</h1>
        <div class="mt-3 alert alert-danger" id="errorContainer" style="display: none;"></div>

        <ul class="list-group" id="itemList">
        </ul>

        <div class="text-center mt-4">
            <button class="btn btn-success" data-toggle="modal" data-target="#addItemModal">Create A Habit</button>
        </div>

        <div id="modifyItemModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modify Item</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Form for modifying item-->
                        <form id="modifyItemForm">
                            <div class="mt-3 alert alert-danger" id="modifyHabitErrorContainer" style="display: none;">
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label for="modifyNameInput">Name:</label>
                                    <input type="text" class="form-control" id="modifyNameInput" name="modifyNameInput"
                                        placeholder="Enter habit name">
                                </div>

                                <div class="form-group col-md-12">
                                    <label for="modifyEffectInput">Effect:</label>
                                    <select id="modifyEffectInput" class="form-control" name="modifyEffectInput">
                                        <option value="good">Good</option>
                                        <option value="bad">Bad</option>
                                    </select>
                                </div>

                                <div class="form-group col-md-12">
                                    <label for="modifyCategoryInput">Category:</label>
                                    <select id="modifyCategoryInput" class="form-control" name="modifyCategoryInput">
                                        <option value="healthandfitness">Health and Fitness</option>
                                        <option value="personaldevelopment">Personal Development</option>
                                        <option value="productivity">Productivity</option>
                                        <option value="financial">Financial</option>
                                        <option value="relationships">Relationships</option>
                                        <option value="careerdevelopment">Career Development</option>
                                        <option value="social">Social</option>
                                        <option value="organization">Organization</option>
                                        <option value="hobbies">Hobbies</option>
                                    </select>
                                </div>

                                <div class="form-group col-md-12">
                                    <label for="modifyWeightInput">Weight:</label>
                                    <input type="text" id="modifyWeightInput" class="form-control"
                                        name="modifyWeightInput" placeholder="Enter habit weight">
                                </div>
                                <div class="form-group col-md-12">
                                    <button type="submit" class="btn btn-success">Save Changes</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="addItemModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Item</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Form for adding item-->
                        <form id="addItemForm" action="/habits/create-habit" method="POST">
                            <div class="mt-3 alert alert-danger" id="addItemErrorContainer" style="display: none;">
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label for="createNameInput">Name:</label>
                                    <input type="text" class="form-control" id="createNameInput" name="createNameInput"
                                        placeholder="Enter habit name">
                                </div>

                                <div class="form-group col-md-12">
                                    <label for="createEffectInput">Effect:</label>
                                    <select id="createEffectInput" class="form-control" name="createEffectInput">
                                        <option value="good">Good</option>
                                        <option value="bad">Bad</option>
                                    </select>
                                </div>

                                <div class="form-group col-md-12">
                                    <label for="createCategoryInput">Category:</label>
                                    <select id="createCategoryInput" class="form-control" name="createCategoryInput">
                                        <option value="healthandfitness">Health and Fitness</option>
                                        <option value="personaldevelopment">Personal Development</option>
                                        <option value="productivity">Productivity</option>
                                        <option value="financial">Financial</option>
                                        <option value="relationships">Relationships</option>
                                        <option value="careerdevelopment">Career Development</option>
                                        <option value="social">Social</option>
                                        <option value="organization">Organization</option>
                                        <option value="hobbies">Hobbies</option>
                                    </select>
                                </div>

                                <div class="form-group col-md-12">
                                    <label for="createWeightInput">Weight:</label>
                                    <input type="text" id="createWeightInput" class="form-control"
                                        name="createWeightInput" placeholder="Enter habit weight">
                                </div>

                                <!-- Add a hidden input field to store the new habit ID -->
                                <input type="hidden" id="newHabitId" name="newHabitId">

                                <div class="form-group col-md-12">
                                    <button type="submit" class="btn btn-success">Create Habit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tracking Habit Modal -->
        <div id="trackHabitModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Track Habit</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Form for tracking habit -->
                        <form id="trackHabitForm">
                            <div class="mt-3 alert alert-danger" id="trackHabitErrorContainer" style="display: none;">
                            </div>
                            <div class="form-group">
                                <label for="reminderTimeInput">Reminder Time:</label>
                                <input type="time" class="form-control" id="reminderTimeInput" name="reminderTimeInput">
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-success">Track Habit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        const items = [];

        /*function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
        }

        function clearError() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = '';
            errorContainer.style.display = 'none';
        } */

        function displayHabitLogError(message, errorContainerId) {
            const errorContainer = document.getElementById(errorContainerId);
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';

            // Optionally, hide the error after a few seconds
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000); // Adjust the timeout as needed
        }

        function renderItems() {
            const itemList = document.getElementById('itemList');
            itemList.innerHTML = '';

            items.forEach(item => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.innerHTML = `
          ${item.name}
          <div>
            <button class="btn btn-primary btn-sm mr-2" onclick="openModifyItemModal('${String(item.id)}')">Modify</button>
            <button class="btn btn-danger btn-sm" onclick="deleteItem('${String(item.id)}')">Delete</button>
            <button class="btn btn-success btn-sm" onclick="openTrackHabitModal('${String(item.id)}')">Track</button>
            <button class="btn btn-warning btn-sm" onclick="untrackHabit('${String(item.id)}')">Untrack</button>
          </div>
        `;
                itemList.appendChild(listItem);
            });
        }

        function openModifyItemModal(itemId) {
            const item = items.find(i => i.id === itemId);

            const modifyItemForm = document.getElementById('modifyItemForm');
            modifyItemForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const modifyNameInput = document.getElementById('modifyNameInput');
                const modifyEffectInput = document.getElementById('modifyEffectInput');
                const modifyCategoryInput = document.getElementById('modifyCategoryInput');
                const modifyWeightInput = document.getElementById('modifyWeightInput');
                const newName = modifyNameInput.value;
                const newEffect = modifyEffectInput.value;
                const newCategory = modifyCategoryInput.value;
                const newWeight = modifyWeightInput.value;

                // Validate the input
                if (newName.trim() === '' || newEffect.trim() === '' || newCategory.trim() === '' || newWeight.trim() === '') {
                    showError('All fields must be filled.');
                    return;
                }

                // Make an AJAX request using jQuery
                $.ajax({
                    type: 'PATCH',
                    url: `/habits/modify/${itemId}`,
                    contentType: 'application/json',
                    data: JSON.stringify({
                        nameInput: newName,
                        effectInput: newEffect,
                        categoryInput: newCategory,
                        weightInput: newWeight,
                    }),
                    success: function (updatedHabit) {
                        const updatedItemIndex = items.findIndex(i => i.id === itemId);
                        if (updatedItemIndex !== -1) {
                            items[updatedItemIndex].name = updatedHabit.name;
                        }

                        renderItems();

                        $('#modifyItemModal').modal('hide');
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Handle error response
                        let errorMessage = jqXHR.responseJSON.error;
                        displayHabitLogError(errorMessage, 'modifyHabitErrorContainer');
                    }
                });
            });

            $('#modifyItemModal').modal('show');
        }

        function deleteHabitOnServer(itemId) {
            $.ajax({
                type: 'DELETE',
                url: '/habits/delete-habit/' + itemId,
                success: function (deletedHabit) {
                    console.log('Habit deleted:', deletedHabit);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Handle error response
                    let errorMessage = jqXHR.responseJSON.error;
                    displayHabitLogError(errorMessage, 'errorContainer');
                }
            });
        }


        function deleteItem(itemId) {
            const confirmDelete = confirm("Are you sure you want to delete this item?");
            if (confirmDelete) {
                deleteHabitOnServer(itemId);

                const newItems = items.filter(item => item.id !== itemId);
                if (newItems.length === items.length) {
                    showError('Item not found.');
                } else {
                    items.length = 0;
                    items.push(...newItems);
                    renderItems();
                }
            }
        }

        function addItem(newItemName) {
            // Validate the input
            if (newItemName.trim() === '') {
                showError('Item name cannot be empty.');
                return;
            }

            const newItemId = items.length + 1;
            items.push({ id: newItemId, name: newItemName });
            renderItems();
            $('#addItemModal').modal('hide');
        }

        document.getElementById('addItemForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const createNameInput = document.getElementById('createNameInput').value;
            const createEffectInput = document.getElementById('createEffectInput').value;
            const createCategoryInput = document.getElementById('createCategoryInput').value;
            const createWeightInput = document.getElementById('createWeightInput').value;

            // Make an AJAX request using jQuery
            $.ajax({
                type: 'POST',
                url: '/habits/create-habit',
                contentType: 'application/json',
                data: JSON.stringify({
                    nameInput: createNameInput,
                    effectInput: createEffectInput,
                    categoryInput: createCategoryInput,
                    weightInput: createWeightInput,
                }),
                success: function (newHabit) {
                    // Add the habit to the items list
                    items.push({ id: newHabit._id, name: newHabit.name });

                    // Update the hidden input field with the new habit ID
                    document.getElementById('newHabitId').value = newHabit._id;

                    // Render the updated items list
                    renderItems();

                    // Hide the modal
                    $('#addItemModal').modal('hide');
                    $(".modal-backdrop").remove();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Handle error response
                    let errorMessage = jqXHR.responseJSON.error;
                    displayHabitLogError(errorMessage, 'addItemErrorContainer');
                }
            });
        });

        function trackHabitFormSubmit(event, itemId) {
            event.preventDefault();

            const reminderTimeInput = document.getElementById('reminderTimeInput').value;

            // Make an AJAX request using jQuery
            $.ajax({
                type: 'POST',
                url: '/habits/track/' + itemId,
                contentType: 'application/json',
                data: JSON.stringify({
                    reminderTimeInput: reminderTimeInput,
                }),
                success: function (response) {
                    console.log('Habit tracked successfully:', response);
                    // Close the tracking modal
                    // Iterate through items and update trackedHabitId when habitId matches
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].id === response.habitId) {
                            items[i].trackedHabitId = response._id;
                        }
                    }

                    $('#trackHabitModal').modal('hide');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Handle error response
                    let errorMessage = jqXHR.responseJSON.error;
                    displayHabitLogError(errorMessage, 'trackHabitErrorContainer');
                }
            });
        }

        function openTrackHabitModal(itemId) {
            const trackHabitForm = document.getElementById('trackHabitForm');

            // Set the itemId as a property of the form
            trackHabitForm.itemId = itemId;

            // Add or update the event listener for the form submission
            trackHabitForm.onsubmit = function (event) {
                trackHabitFormSubmit(event, this.itemId);
            };

            $('#trackHabitModal').modal('show');
        }

        function untrackHabit(itemId) {
            const confirmUntrack = confirm("Are you sure you want to untrack this habit?");
            if (confirmUntrack) {
                // Find the tracked habit Id for the habit
                let habitToUntrackId;
                let habitToUntrack;

                for (let i = 0; i < items.length; i++) {
                    const currentHabit = items[i];
                    if (currentHabit.id === itemId) {
                        habitToUntrackId = currentHabit.trackedHabitId;
                        habitToUntrack = currentHabit;
                    }
                }

                // Make an AJAX request to untrack the habit
                $.ajax({
                    type: 'DELETE',
                    url: '/tracked-habits/delete/' + habitToUntrackId,
                    success: function () {
                        console.log('Habit untracked successfully.');
                        delete habitToUntrack.trackedHabitId;
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Handle error response
                        let errorMessage = jqXHR.responseJSON.error;
                        displayHabitLogError(errorMessage, 'errorContainer');
                    }
                });
            }
        }


        function getHabitData() {
            $.ajax({
                type: 'GET',
                url: '/habits/view-all',
                success: function (response) {
                    for (let item of response) {
                        items.push({ id: item._id, name: item.name });
                    }

                    $.ajax({
                        type: 'GET',
                        url: '/tracked-habits/get-all',
                        success: function (response) {
                            // Render the habits on the page
                            for (let i = 0; i < items.length; i++) {
                                for (let item of response) {
                                    if (items[i].id === item.habitId) {
                                        items[i].trackedHabitId = item._id;
                                    }
                                }
                            }
                            renderItems();
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            // Handle error response
                            let errorMessage = jqXHR.responseJSON.error;
                            displayHabitLogError(errorMessage, 'errorContainer');
                        }
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Handle error response
                    let errorMessage = jqXHR.responseJSON.error;
                    displayHabitLogError(errorMessage, 'errorContainer');
                }
            });
        }

        $(document).ready(function () {
            getHabitData();
        });

        renderItems();
    </script>
</body>

</html>